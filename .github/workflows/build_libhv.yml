name: Cross-platform Build libhv

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *' # 每 4 小时检查一次

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ env.upload_url }}
      NEED_BUILD: ${{ env.NEED_BUILD }}
      REMOTE_LATEST_VERSION: ${{ env.REMOTE_LATEST_VERSION }}
    steps:
      - name: Checkout Current Repository
        uses: actions/checkout@v3

      - name: Check if build is required
        id: check-build-need
        run: |
          wget --no-check-certificate https://raw.githubusercontent.com/george012/gt_script/master/github_repo_version_scan.sh
          chmod a+x ./github_repo_version_scan.sh
          build_need=$(./github_repo_version_scan.sh --check_need_update github.com/$GITHUB_REPOSITORY github.com/ithewei/libhv)
          remote_latest_version=$(./github_repo_version_scan.sh --get_latest_version github.com/ithewei/libhv)
          echo "NEED_BUILD=$build_need" >> $GITHUB_ENV
          echo "REMOTE_LATEST_VERSION=$remote_latest_version" >> $GITHUB_ENV
          upload_url=$(./github_repo_version_scan.sh --get_latest_upload_url github.com/$GITHUB_REPOSITORY)
          echo "upload_url=$upload_url" >> $GITHUB_ENV
        env:
          NEED_BUILD: $build_need
          REMOTE_LATEST_VERSION: $remote_latest_version

      - name: Set up Git
        if: ${{ env.NEED_BUILD }} == "yes"
        run: |
          git config --local user.email "${{ secrets.GITCONFIG_EMAIL }}"
          git config --local user.name "${{ secrets.GITCONFIG_NAME }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version and push tag
        id: tag-version
        if: ${{ env.NEED_BUILD }} == "yes"
        uses: mathieudutour/github-tag-action@v6.1
        with:
          tag_prefix: ""
          custom_tag: ${{ env.REMOTE_LATEST_VERSION }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Step GitHub release
        id: step-create-release
        if: ${{ env.NEED_BUILD }} == "yes"
        uses: ncipollo/release-action@v1
        with:
          skipIfReleaseExists: 'true'
          tag: ${{ steps.tag-version.outputs.new_tag }}
          name: ${{ steps.tag-version.outputs.new_tag }}

      - name: handle Upload Url
        run: |
          if [ "${{ env.NEED_BUILD }}" == "yes" ]; then
            echo "upload_url=${{ steps.step-create-release.outputs.upload_url }}" >> $GITHUB_ENV
          fi

  build-linux:
    name: build-linux  
    needs: create-release
    if: ${{ needs.create-release.outputs.NEED_BUILD }} == "yes"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Handle ENV PATH
        run: |
          echo "NEED_BUILD=${{ needs.create-release.outputs.NEED_BUILD }}" >> $GITHUB_ENV
          echo "REMOTE_LATEST_VERSION=${{ needs.create-release.outputs.REMOTE_LATEST_VERSION }}" >> $GITHUB_ENV
          echo "upload_url=${{ needs.create-release.outputs.upload_url }}" >> $GITHUB_ENV

      - uses: actions/checkout@v3
        with:
          submodules: 'recursive'
      - name: install dependencies
        run: |
           sudo apt update
           sudo apt install -y build-essential cmake git jq libssl-dev libnghttp2-dev
           mkdir -p ./libhv/build_libs

      - name: build x86_64
        run: |
          cd libhv
          mkdir build-x86_64 && cd build-x86_64
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=./install -DBUILD_SHARED_LIBS=ON -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DCMAKE_OSX_ARCHITECTURES="x86_64"
          make -j$(nproc) VERBOSE=1

      - name: build arm64
        run: |
          cd libhv
          mkdir build-arm64 && cd build-arm64
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=./install -DBUILD_SHARED_LIBS=ON -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DCMAKE_OSX_ARCHITECTURES="arm64"
          make -j$(nproc) VERBOSE=1

      - name: merge libs
        run: |
          cd ./libhv/build_libs
          mkdir -p ./libhv/include
          ld -shared -o ./libhv/libhv.so ../build-arm64/lib/libhv.so ../build-x86_64/lib/libhv.so
          cp ../include/hv/* ./libhv/include
          zip -q -r libhv_linux_x64_arm64.zip ./libhv
          echo "over_file_name=libhv_linux_x64_arm64.zip" >> $GITHUB_ENV

      - name: Check for existing asset
        id: check_asset_existing
        run: |
            wget --no-check-certificate https://raw.githubusercontent.com/george012/gt_script/master/github_repo_version_scan.sh
            chmod a+x ./github_repo_version_scan.sh
            file_exist=$(./github_repo_version_scan.sh --check_file_exist_from_repo_latest github.com/$GITHUB_REPOSITORY ${{ env.over_file_name }})
            echo "file_exist=$file_exist" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dynamic library as release asset
        if: ${{ env.file_exist }} != "yes"
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./libhv/build_libs/${{ env.over_file_name }}
          asset_name: ${{ env.over_file_name }}
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
  build-windows:
    name: build-windows
    needs: create-release
    if: ${{ needs.create-release.outputs.NEED_BUILD }} == "yes"
    runs-on: windows-2022
    permissions:
      contents: write
    steps:
      - name: Handle ENV PATH
        shell: pwsh
        run: |
          echo "NEED_BUILD=${{ needs.create-release.outputs.NEED_BUILD }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "NEED_BUILD=${{ needs.create-release.outputs.REMOTE_LATEST_VERSION }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "NEED_BUILD=${{ needs.create-release.outputs.upload_url }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
  
      - uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: install dependencies
        run: |
          choco install -y openssl.light tree cmake
          mkdir -p libhv/build_libs

      - name: build x86_64
        run: |
          cd libhv
          mkdir cmake-build-win64 && cd cmake-build-win64
          cmake .. -G "Visual Studio 17 2022" -A x64
          cmake --build .

      - name: build arm64
        run: |
          cd libhv
          mkdir cmake-build-arm64 && cd cmake-build-arm64
          cmake .. -G "Visual Studio 17 2022" -A ARM64
          cmake --build .

      - name: merge DLLs
        run: |
          cd libhv/build_libs
          mkdir -p libhv/include
          mkdir -p libhv/x64
          mkdir -p libhv/arm64
          cp ../cmake-build-win64/bin/Debug/hv.dll libhv/x64/
          cp ../cmake-build-arm64/bin/Debug/hv.dll libhv/arm64/
          cp ../include/hv/* ./libhv/include
          7z a libhv_windows_x64_arm64.zip ./libhv
          echo "over_file_name=libhv_windows_x64_arm64.zip" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
      - name: Check for existing asset
        id: check_asset_existing
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri https://raw.githubusercontent.com/george012/gt_script/master/github_repo_version_scan.ps1 -OutFile github_repo_version_scan.ps1
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
          . .\github_repo_version_scan.ps1
          $file_exist = Check-FileExistFromRepoLatest -Repo "github.com/$env:GITHUB_REPOSITORY" -FileName "$env:over_file_name" -Token "$env:GITHUB_TOKEN"
          echo "file_exist=$file_exist" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dynamic library as release asset
        if: ${{ env.file_exist }} != "yes"
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./libhv/build_libs/${{ env.over_file_name }}
          asset_name: ${{ env.over_file_name }}
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-apple:
    name: build-apple
    needs: create-release
    if: ${{ needs.create-release.outputs.NEED_BUILD }} == "yes"
    runs-on: macos-latest
    permissions:
      contents: write
    env:
      HOMEBREW_NO_AUTO_UPDATE: true
    steps:
      - name: Handle ENV PATH
        run: |
          echo "NEED_BUILD=${{ needs.create-release.outputs.NEED_BUILD }}" >> $GITHUB_ENV
          echo "REMOTE_LATEST_VERSION=${{ needs.create-release.outputs.REMOTE_LATEST_VERSION }}" >> $GITHUB_ENV
          echo "upload_url=${{ needs.create-release.outputs.upload_url }}" >> $GITHUB_ENV
  
      - uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: install dependencies
        run: |
          brew install openssl@1.1 nghttp2 cmake
          mkdir -p libhv/build_libs

      - name: build x86_64 and arm64
        run: |
          cd libhv
          build() {
            platform=$1
            archs=$2
            deployment_target=$3
            mkdir -p build-$platform && cd build-$platform
            cmake .. -G Xcode -DCMAKE_TOOLCHAIN_FILE=../cmake/ios.toolchain.cmake -DPLATFORM="$platform" -DDEPLOYMENT_TARGET="$deployment_target" -DARCHS="$archs" -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX=./install -DCMAKE_BUILD_TYPE=Release
            cmake --build . --target hv_shared --config Release
            cd ..
          }
          build OS64COMBINED "arm64;x86_64" 9.0
          build TVOSCOMBINED "arm64;x86_64" 9.0
          build WATCHOSCOMBINED "arm64;x86_64" 9.0
          build MAC_UNIVERSAL "arm64;x86_64" 10.12

      - name: merge dylibs and fix @rpath
        run: |
          cd libhv/build_libs
          mkdir -p ./libhv/include
          lipo -create -output libhv.dylib ../build-OS64COMBINED/install/lib/libhv.dylib ../build-TVOSCOMBINED/install/lib/libhv.dylib ../build-WATCHOSCOMBINED/install/lib/libhv.dylib ../build-MAC_UNIVERSAL/install/lib/libhv.dylib
          install_name_tool -id @rpath/libhv.dylib libhv.dylib
          install_name_tool -change /usr/local/opt/openssl@1.1/lib/libssl.1.1.dylib @rpath/libssl.1.1.dylib libhv.dylib
          install_name_tool -change /usr/local/opt/openssl@1.1/lib/libcrypto.1.1.dylib @rpath/libcrypto.1.1.dylib libhv.dylib
          install_name_tool -change /usr/local/opt/nghttp2/lib/libnghttp2.14.dylib @rpath/libnghttp2.14.dylib libhv.dylib
          cp ../include/hv/* ./libhv/include
          mv libhv.dylib ./libhv/
          zip -q -r libhv_apple_universal.zip ./libhv
          echo "over_file_name=libhv_apple_universal.zip" >> $GITHUB_ENV

      - name: Check for existing asset
        id: check_asset_existing
        run: |
            wget --no-check-certificate https://raw.githubusercontent.com/george012/gt_script/master/github_repo_version_scan.sh
            chmod a+x ./github_repo_version_scan.sh
            file_exist=$(./github_repo_version_scan.sh --check_file_exist_from_repo_latest github.com/$GITHUB_REPOSITORY ${{ env.over_file_name }})
            echo "file_exist=$file_exist" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dynamic library as release asset
        if: ${{ env.file_exist }} != "yes"
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./libhv/build_libs/${{ env.over_file_name }}
          asset_name: ${{ env.over_file_name }}
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android:
    name: build-android
    needs: create-release
    if: ${{ needs.create-release.outputs.NEED_BUILD }} == "yes"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: install dependencies
        run: |
          echo "NEED_BUILD=${{ needs.create-release.outputs.NEED_BUILD }}" >> $GITHUB_ENV
          echo "REMOTE_LATEST_VERSION=${{ needs.create-release.outputs.REMOTE_LATEST_VERSION }}" >> $GITHUB_ENV
          echo "upload_url=${{ needs.create-release.outputs.upload_url }}" >> $GITHUB_ENV
          sudo apt update
          sudo apt install -y build-essential cmake git jq wget zip unzip tar tree
          mkdir -p libhv/build_libs

      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8

      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r25c

      - name: Build dynamic library for Android-armeabi-v7a
        run: |
          cd libhv
          mkdir build-armeabi-v7a && cd build-armeabi-v7a
          echo ${{ steps.setup-ndk.outputs.ndk-path }}
          cmake \
            -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DANDROID_ABI=armeabi-v7a ..
          cmake --build .
          tree
          cp ./lib/libhv.so ./build_libs/libhv-armeabi-v7a.so

      - name: Build dynamic library for Android-armv8a-arm64
        run: |
          cd libhv
          mkdir build-arm64-v8a && cd build-arm64-v8a
          echo ${{ steps.setup-ndk.outputs.ndk-path }}
          cmake \
            -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DANDROID_ABI=arm64-v8a ..
          cmake --build .
          cp ./lib/libhv.so ./build_libs/libhv-arm64-v8a.so

      - name: Build dynamic library for Android-x86
        run: |
          cd libhv
          mkdir build-x86 && cd build-x86
          echo ${{ steps.setup-ndk.outputs.ndk-path }}
          cmake \
            -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DANDROID_ABI=x86 ..
          cmake --build .
          cp ./lib/libhv.so ./build_libs/libhv-x86.so

      - name: Build dynamic library for Android-x86_64
        run: |
          cd libhv
          mkdir build-x86_64 && cd build-x86_64
          echo ${{ steps.setup-ndk.outputs.ndk-path }}
          cmake \
            -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DANDROID_ABI=x86_64 ..
          cmake --build .
          cp ./lib/libhv.so ./build_libs/libhv-x86_x64.so

      - name: Zip the .so files
        run: |
          cd libhv/build_libs
          mkdir -p libhv/include
          mv libhv-armeabi-v7a.so ./libhv
          mv libhv-arm64-v8a.so ./libhv
          mv libhv-x86.so ./libhv
          mv libhv-x86_x64.so ./libhv
          cp ../include/hv/* ./libhv/include
          zip -q -r libhv_android_v7a_v8a_x64.zip ./libhv
          echo "over_file_name=libhv_android_v7a_v8a_x64.zip" >> $GITHUB_ENV

      - name: Check for existing asset
        id: check_asset_existing
        run: |
            wget --no-check-certificate https://raw.githubusercontent.com/george012/gt_script/master/github_repo_version_scan.sh
            chmod a+x ./github_repo_version_scan.sh
            file_exist=$(./github_repo_version_scan.sh --check_file_exist_from_repo_latest github.com/$GITHUB_REPOSITORY ${{ env.over_file_name }})
            echo "file_exist=$file_exist" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dynamic library as release asset
        if: ${{ env.file_exist }} != "yes"
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./libhv/build_libs/${{ env.over_file_name }}
          asset_name: ${{ env.over_file_name }}
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
